(function(){var e={name:"Nerati",version:"0.0.1"};e.App={name:"neratibookstoreapp",version:"0.0.1",authToken:null,loginScreen:"visible",apiHost:"http://localhost:8080",currentSort:"?newest",routes:{login:"/login",books:"/books"},settings:{init:!1,$loginForm:$("#login"),$loginButton:$("#loginButton"),$createTrigger:$("#addButton"),$updateButton:$("#updateButton"),$cancelButton:$(".cancelButton"),$deleteButton:$("#deleteButton"),$resetButton:$(".resetButton"),$listContainer:$("#books-list"),$listRepeater:$("#books-list-contents"),$detailContainer:$("#book-detail"),$createContainer:$("#book-create"),$createButton:$("#createButton"),$createForm:$("#book-create-form"),$editForm:$("#book-detail-form"),$sortByNewestButton:$("#sortNewestLink"),$sortByOldestButton:$("#sortOldestLink")},init:function(){var e=this;e.setLoginForm();e.settings.init=!0;return e.settings.init},getJSONFormData:function(e){var t=e.serializeArray(),n={};$.map(t,function(e,t){n[e.name]=e.value});return JSON.stringify(n)},bookstoreAjaxAdaptor:function(e,t,n,r){var i=this,r=r||"GET";return $.ajax({type:r,contentType:"application/json",url:i.apiHost+e,data:t,processData:!1,dataType:"json",scope:i,headers:{"X-Bookstore-Token":i.authToken}}).done(n)},setLoginForm:function(){var e=this;e.settings.$loginButton.on("click",function(){var t=e.getJSONFormData(e.settings.$loginForm);e.bookstoreAjaxAdaptor(e.routes.login,t,e.cb_doLogin,"POST");return!1});return e},setAuthToken:function(e){var t=this;t.authToken=e},getBookstore:function(){var e=this;e.bookstoreAjaxAdaptor(e.routes.books+e.currentSort,null,e.cb_renderBooks);return e},setBookCreate:function(){var e=this;e.settings.$createTrigger.on("click",function(){e.settings.$createContainer.foundation("reveal","open")});e.settings.$createButton.on("click",function(){var t=e.getJSONFormData(e.settings.$createForm);e.bookstoreAjaxAdaptor(e.routes.books,t,e.cb_createBook,"POST");return!1});return e},setBookEdit:function(){var e=this;e.settings.$updateButton.on("click",function(){var t=e.getJSONFormData(e.settings.$editForm),n=$('input[data-model="bookId"]',e.settings.$detailContainer).val();e.bookstoreAjaxAdaptor(e.routes.books+"/"+n,t,e.cb_updateBook,"PUT");return!1});e.settings.$deleteButton.on("click",function(){var t=e.getJSONFormData(e.settings.$editForm),n=$('input[data-model="bookId"]',e.settings.$detailContainer).val();e.bookstoreAjaxAdaptor(e.routes.books+"/"+n,t,e.cb_deleteBook,"DELETE");return!1});return e},setBookSort:function(){var e=this;e.settings.$sortByNewestButton.on("click",function(){e.currentSort="?newest";e.settings.$sortByOldestButton.removeClass("active");$(this).toggleClass("active");e.bookstoreAjaxAdaptor(e.routes.books+e.currentSort,null,e.cb_renderBooks)});e.settings.$sortByOldestButton.on("click",function(){e.currentSort="?oldest";e.settings.$sortByNewestButton.removeClass("active");$(this).toggleClass("active");e.bookstoreAjaxAdaptor(e.routes.books+e.currentSort,null,e.cb_renderBooks)})},cb_doLogin:function(e,t,n){this.scope.setAuthToken(n.getResponseHeader("X-Bookstore-Token"));this.scope.getBookstore().setBookCreate().setBookEdit().setBookSort()},cb_renderBooks:function(e,t,n){var r=this.scope,i=e.items;r.settings.$listRepeater.empty();for(var s=0;i[s];s++){var o=i[s];r.bookstoreAjaxAdaptor(o.href,null,r.cb_renderBookSummary)}r.ui_showBookstore()},cb_createBook:function(e,t,n){var r=this.scope;r.settings.$detailContainer.foundation("reveal","close");r.ui_renderBookHtml(e,"new")},cb_updateBook:function(e,t,n){var r=this.scope,i=$("#"+e.id);r.settings.$detailContainer.foundation("reveal","close");r.ui_renderBookHtml(e,"new",i)},cb_deleteBook:function(e,t,n){var r=this.scope,i=$("#"+e.deletedBookId);r.settings.$detailContainer.foundation("reveal","close");i.addClass("deleted");i.fadeOut(function(){i.remove()})},cb_renderBookSummary:function(e,t,n){var r=this.scope;r.ui_renderBookHtml(e)},cb_renderBookDetail:function(e,t,n){var r=this.scope,i=r.settings.$detailContainer;$('input[data-model="bookId"]',i).val(e.id);$('label[data-model="title"] > input.field-input',i).val(e.title);$('label[data-model="author"] > input.field-input',i).val(e.author);r.settings.$detailContainer.foundation("reveal","open")},ui_showBookstore:function(){var e=this;e.loginScreen==="visible"&&e.settings.$loginForm.fadeOut(function(){e.settings.$listContainer.fadeIn();e.loginScreen="hidden"})},ui_renderBookHtml:function(e,t,n){var r=this,t=t||"",i=n||$(document.createElement("tr")),s=$(document.createElement("td")),o=$(document.createElement("a")),u=e._links.filter(function(e){return e.rel==="self"?!0:!1})[0];i.empty();o.attr("href",u.href);o.append(document.createTextNode(e.title));o.on("click",function(){r.bookstoreAjaxAdaptor(u.href,null,r.cb_renderBookDetail);return!1});s.append(o);i.append(s);s=$(document.createElement("td"));s.append(document.createTextNode(e.author));i.attr("id",e.id);i.append(s);i.addClass(t);if(t==="new"){i.css("display","none");i.prependTo(r.settings.$listRepeater);i.fadeIn();var a=setTimeout(function(){i.toggleClass(t)},3e3)}else i.appendTo(r.settings.$listRepeater)}};e.App.init()})();